<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Estimate | Prakash Jewellers</title>

    <link
        href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&family=Lato:wght@300;400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --brand-gold: #c5a065;
            --brand-bg: #fffbf2;
            --header-bg: #fefaef;
            --table-header: #f7e7ce;
            --text-dark: #2c241b;
            --border-color: #e6dfd1;
        }

        @page {
            size: A4;
            margin: 0;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Lato', sans-serif;
            background: #f0f0f0;
            color: var(--text-dark);
            margin: 0;
            padding: 20px;
            font-size: 14px;
        }

        .paper-sheet {
            background: white;
            width: 210mm;
            min-height: 297mm;
            /* A4 Height */
            margin: 0 auto;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            position: relative;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjEiIGZpbGw9InJnYmEoMjAwLCAxODAsIDE1MCwgMC4wNSkiLz48L3N2Zz4=');
            /* Flexbox for footer pinning */
            display: flex;
            flex-direction: column;
            /* Decorative border */
            border: 3px double var(--brand-gold);
            outline: 1px solid #e6dfd1;
            outline-offset: 4px;
        }

        .main-content {
            flex: 1 1 auto;
        }

        .page-footer {
            flex-shrink: 0;
            margin-top: auto;
        }

        /* --- Header --- */
        header {
            text-align: center;
            margin-bottom: 10px;
        }

        .logo-img {
            max-width: 120px;
            margin-bottom: 2px;
        }

        .brand-name {
            font-family: 'Crimson Text', serif;
            font-size: 1.6rem;
            margin: 2px 0 0 0;
            color: var(--brand-gold);
            letter-spacing: 1px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .brand-sub {
            font-size: 0.9rem;
            letter-spacing: 3px;
            color: #888;
            text-transform: uppercase;
            margin-top: 2px;
        }

        .brand-address {
            margin-top: 8px;
            font-size: 1rem;
            color: #444;
        }

        .brand-contact {
            font-weight: 700;
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 0.9rem;
        }

        /* --- Section Divider --- */
        .rough-estimate-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            color: var(--brand-gold);
            font-family: 'Crimson Text', serif;
            font-size: 1.1rem;
        }

        .rough-estimate-divider::before,
        .rough-estimate-divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid #e0cda8;
            margin: 0 15px;
        }

        /* --- Info Grid --- */
        .info-grid {
            background: #fdfaf5;
            padding: 2px 0;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            border-top: 1px solid var(--brand-gold);
            border-bottom: 1px solid var(--brand-gold);
        }

        .info-cell {
            padding: 6px 10px;
            display: flex;
            align-items: center;
        }

        .info-cell label {
            font-weight: 700;
            margin-right: 10px;
            min-width: 80px;
            font-family: 'Crimson Text', serif;
            font-size: 1.1rem;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        input[type="tel"] {
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 1rem;
            width: 100%;
            border-bottom: 1px dotted #ccc;
            padding: 4px;
        }

        input:focus {
            outline: none;
            border-bottom: 1px solid var(--brand-gold);
        }

        .v-partition {
            border-left: 1px solid #e0cda8;
        }

        /* --- Estimate Title --- */
        .section-title {
            background: #efebe4;
            padding: 8px 15px;
            font-family: 'Crimson Text', serif;
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #4a4a4a;
            border-left: 4px solid var(--brand-gold);
        }

        /* --- Table --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 8px;
            border: 2px solid #c5a065;
        }

        th {
            background: var(--table-header);
            color: #5c4a35;
            font-family: 'Crimson Text', serif;
            font-weight: 700;
            padding: 6px 4px;
            text-align: center;
            border: 1px solid #d4c4a8;
            font-size: 0.85rem;
        }

        td {
            padding: 4px 6px;
            border: 1px solid #d4c4a8;
            text-align: center;
            vertical-align: middle;
            font-size: 0.9rem;
        }

        .desc-col {
            text-align: left;
            padding-left: 10px;
        }

        td input {
            text-align: center;
            border-bottom: none;
        }

        td input.text-left {
            text-align: left;
        }

        /* --- Old Gold & Calculations --- */
        .calc-section {
            display: flex;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .calc-box {
            width: 350px;
            border: 1px solid var(--brand-gold);
            border-radius: 4px;
            overflow: hidden;
        }

        .calc-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 15px;
            border-bottom: 1px solid #eee;
            background: #fdfaf5;
        }

        .calc-row:last-child {
            border-bottom: none;
        }

        .calc-row.total {
            background: linear-gradient(to right, #f3e5d0, #f7eadd);
            font-weight: 700;
            font-family: 'Crimson Text', serif;
            font-size: 1.2rem;
            color: #3d3d3d;
        }

        /* --- Footer --- */
        .footer {
            margin-top: 15px;
            padding-top: 8px;
            border-top: 1px dashed #ccc;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .qr-box {
            width: 120px;
            height: 120px;
            border: 2px solid var(--brand-gold);
            padding: 5px;
            text-align: center;
        }

        .qr-placeholder {
            width: 100%;
            height: 100%;
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #666;
        }

        .terms {
            font-size: 0.8rem;
            color: #555;
            background: #f5f1ea;
            padding: 10px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .terms ul {
            margin: 0;
            padding-left: 18px;
        }

        .terms li {
            margin-bottom: 3px;
        }

        .auth-sign {
            text-align: right;
            margin-top: -40px;
        }

        .sign-line {
            width: 200px;
            border-top: 1px solid #777;
            margin-bottom: 5px;
            display: inline-block;
        }

        .footer-note {
            text-align: center;
            margin-top: 15px;
            font-family: 'Crimson Text', serif;
            font-size: 1.1rem;
            background: #fcfcfc;
            padding: 8px;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

        /* --- Buttons (No Print) --- */
        .btn-add {
            background: white;
            border: 1px dashed #aaa;
            color: #666;
            width: 100%;
            padding: 5px;
            cursor: pointer;
            margin-top: -6px;
            margin-bottom: 15px;
        }

        .btn-add:hover {
            background: #f9f9f9;
            border-color: var(--brand-gold);
            color: var(--brand-gold);
        }

        .screen-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .action-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-print {
            background: var(--brand-gold);
            color: white;
        }

        .btn-reset {
            background: white;
            color: #c0392b;
        }

        .remove-icon {
            color: #e74c3c;
            cursor: pointer;
            font-size: 0.9rem;
            opacity: 0.5;
        }

        .remove-icon:hover {
            opacity: 1;
        }

        /* --- Print Media Query --- */
        @media print {
            @page {
                size: A4;
                margin: 0;
            }

            html,
            body {
                width: 210mm;
                height: 297mm;
                background: white;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }

            .paper-sheet {
                width: 100%;
                height: 297mm;
                min-height: 297mm;
                max-height: 297mm;
                margin: 0;
                box-shadow: none;
                padding: 10mm 15mm;
                background: white !important;
                page-break-inside: avoid;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            .main-content {
                flex: 1 1 auto;
            }

            .page-footer {
                flex-shrink: 0;
                margin-top: auto;
            }

            .screen-controls,
            .btn-add,
            .no-print,
            .remove-icon {
                display: none !important;
            }

            .hide-in-print {
                display: none !important;
            }

            /* Professional Styling tweaks for Print */
            body {
                font-family: 'Times New Roman', serif;
                /* Classic professional font for print, or keep Lato/Crimson */
                color: #000;
            }

            .brand-name {
                color: #000 !important;
                /* High contrast */
            }

            .section-title {
                background: #f3f3f3 !important;
                border-left: 4px solid #333 !important;
                color: #000 !important;
                padding: 5px 10px !important;
            }

            table {
                border: 1px solid #333 !important;
            }

            th {
                background: #eee !important;
                color: #000 !important;
                border: 1px solid #333 !important;
                font-weight: bold;
            }

            td {
                border: 1px solid #ccc !important;
                color: #000;
            }

            input {
                font-weight: 500;
                color: #000;
            }

            .calc-row.total {
                background: transparent !important;
                border-top: 2px solid #000;
            }

            /* Ensure it fits on one page by reducing spacing if needed */
            .info-grid {
                margin-bottom: 10px;
                border-color: #333 !important;
            }

            .rough-estimate-divider {
                color: #333 !important;
                margin: 5px 0 !important;
            }

            .rough-estimate-divider::before,
            .rough-estimate-divider::after {
                border-bottom: 1px solid #333 !important;
            }
        }

        /* --- Mobile Responsive --- */
        @media screen and (max-width: 768px) {
            body {
                padding: 5px;
            }

            .paper-sheet {
                width: 100%;
                min-height: auto;
                padding: 15px;
                margin: 0;
            }

            .screen-controls {
                position: fixed;
                bottom: 10px;
                top: auto;
                right: 10px;
                flex-direction: row;
                gap: 8px;
            }

            .action-btn {
                padding: 10px 15px;
                font-size: 0.85rem;
            }

            .logo-img {
                max-width: 100px;
            }

            .brand-contact {
                position: static;
                text-align: center;
                margin-bottom: 10px;
            }

            header {
                margin-bottom: 8px;
            }

            .rough-estimate-divider {
                font-size: 1rem;
                margin: 8px 0;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .v-partition {
                border-left: none;
                border-top: 1px solid #e0cda8;
            }

            th,
            td {
                padding: 4px 2px;
                font-size: 0.75rem;
            }

            td input {
                font-size: 0.8rem;
            }

            .section-title {
                font-size: 1rem;
                padding: 6px 10px;
            }

            .calc-box {
                width: 100%;
            }

            .footer {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }

            .footer>div {
                text-align: center;
            }

            .qr-box {
                width: 100px !important;
            }

            .terms {
                font-size: 0.75rem;
                padding: 8px;
            }

            .footer-note {
                font-size: 1rem;
            }
        }
    </style>
</head>

<body>

    <div class="screen-controls">
        <button class="action-btn btn-print" onclick="window.print()"><i class="fas fa-print"></i> Print
            Invoice</button>
        <button class="action-btn btn-reset" onclick="resetForm()"><i class="fas fa-trash"></i> Reset</button>
    </div>

    <div class="paper-sheet">
        <div class="main-content">
            <!-- Brand Header -->
            <header>
                <div class="brand-contact">Mob: +91-9897452528</div>
                <img src="./assets/Logo.png" alt="Prakash Jewellers" class="logo-img">
                <div class="brand-address">Near Thakur Dwara Mandir, Main Market, Deoband</div>
            </header>

            <div class="rough-estimate-divider">Rough Estimate</div>

            <!-- Customer Details -->
            <div class="info-grid">
                <div style="display: flex; flex-direction: column;">
                    <div class="info-cell">
                        <label>Customer:</label>
                        <input type="text" id="custName" oninput="saveData()">
                    </div>
                </div>
                <div class="v-partition" style="display: flex; flex-direction: column;">
                    <div class="info-cell">
                        <label>Date:</label>
                        <input type="text" id="billDateStr" readonly style="font-weight: 600;">
                        <input type="hidden" id="billDate">
                    </div>
                    <div class="info-cell">
                        <label>Estimate No:</label>
                        <input type="text" id="estNo" value="PJ-001" oninput="saveData()">
                    </div>
                </div>
            </div>

            <!-- Main Items Table -->
            <div class="section-title">Estimate</div>
            <table id="mainTable">
                <thead>
                    <tr>
                        <th width="5%" class="no-print">#</th>
                        <th width="35%">Description</th>
                        <th width="12%">Weight (g)</th>
                        <th width="12%">Rate</th>
                        <th width="12%">Misc</th>
                        <th width="15%">Amount (‚Çπ)</th>
                        <th width="5%" class="no-print"></th>
                    </tr>
                </thead>
                <tbody id="mainBody">
                    <!-- Rows injected via JS -->
                </tbody>
            </table>
            <button class="btn-add no-print" onclick="addMainRow()">+ Add Item Row</button>

            <!-- Old Gold Section -->
            <div id="oldGoldSection">
                <div class="section-title" style="margin-top: 15px; background: #fff1f1; border-color: #e74c3c;">Old
                    Items
                    Deduction</div>
                <table id="oldTable">
                    <thead>
                        <tr>
                            <th width="35%">Description</th>
                            <th width="15%">Weight (g)</th>
                            <th width="15%">Purity %</th>
                            <th width="15%">Rate</th>
                            <th width="15%">Value (‚Çπ)</th>
                            <th width="5%" class="no-print"></th>
                        </tr>
                    </thead>
                    <tbody id="oldBody">
                        <!-- Rows injected via JS -->
                    </tbody>
                </table>
            </div>
            <button class="btn-add no-print" onclick="addOldRow()" style="color: #c0392b; border-color: #e6b0aa;">+ Add
                Old
                Gold Row</button>

            <!-- Calculations -->
            <div class="calc-section">
                <div class="calc-box">
                    <div class="calc-row">
                        <span>Subtotal</span>
                        <span id="txtSubtotal">‚Çπ 0</span>
                    </div>
                    <div class="calc-row" id="oldDeductionRow">
                        <span>Old Items Deduction</span>
                        <span id="txtOldTotal">‚Çπ 0</span>
                    </div>
                    <div class="calc-row total">
                        <span>Total</span>
                        <span id="txtGrandTotal">‚Çπ 0</span>
                    </div>
                </div>
            </div>

            <div class="page-footer">
                <!-- Footer -->
                <div class="footer">
                    <div style="flex:1;">
                        <div class="qr-box" style="border:none; padding:0; width: 140px; height: auto;">
                            <img src="./assets/Insta_page_logo.png" style="width:100%; height:auto;"
                                alt="Follow on Instagram">
                        </div>
                    </div>

                    <div style="flex:2; text-align: right;">
                        <div class="sign-line"></div>
                        <div style="padding-right: 40px; font-weight: 600; font-family: 'Crimson Text', serif;">
                            Authorized
                            Signature</div>
                    </div>
                </div>

                <div class="terms">
                    <ul>
                        <li>‡§∏‡§æ‡§Æ‡§æ‡§® ‡§¨‡§¶‡§≤‡§®‡•á ‡§ï‡•Ä ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§ï‡•á‡§µ‡§≤ 3 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§§‡§ï ‡§π‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•à‡•§</li>
                        <li>‡§á‡§∏‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§µ‡§æ‡§™‡§∏‡•Ä ‡§ï‡•á‡§µ‡§≤ 85% ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§™‡§∞ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡•Ä ‡§ú‡§æ‡§è‡§ó‡•Ä‡•§</li>
                        <li>‡§≤‡•ã‡§Ç‡§ó ‡§è‡§µ‡§Ç ‡§õ‡•ã‡§ü‡•Ä ‡§¨‡§æ‡§≤‡•Ä 75% ‡§ï‡•Ä ‡§π‡•Ä ‡§Ü‡§§‡•Ä ‡§π‡•à‡•§</li>
                    </ul>
                </div>

                <div class="footer-note">
                    Thank you for visiting <span style="color: #e67e22;">üôè</span>
                </div>
            </div>
        </div>

        <script>
            // --- Utils ---
            const formatCurrency = (num) => Math.round(num).toLocaleString('en-IN');
            const todayStr = () => {
                const d = new Date();
                return `${String(d.getDate()).padStart(2, '0')}-${String(d.getMonth() + 1).padStart(2, '0')}-${d.getFullYear()}`;
            }

            // --- State & Init ---
            let mainRows = [];
            let oldRows = [];

            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('billDateStr').value = todayStr();

                // Always start fresh on page load with a new estimate number
                document.getElementById('estNo').value = getNextEstimateNumber();

                if (mainRows.length === 0) addMainRow();
                if (oldRows.length === 0) addOldRow();
                render();
            });

            // --- Actions ---
            function getNextEstimateNumber() {
                let counter = parseInt(localStorage.getItem('pj_est_counter'));
                if (isNaN(counter)) counter = 0;
                counter++;
                localStorage.setItem('pj_est_counter', counter);
                return `PJ-${String(counter).padStart(3, '0')}`;
            }

            // --- Actions ---
            const MAX_MAIN_ROWS = 8;
            const MAX_OLD_ROWS = 3;

            function addMainRow(data = {}) {
                if (mainRows.length >= MAX_MAIN_ROWS) {
                    alert(`Maximum ${MAX_MAIN_ROWS} items allowed to fit on one page.`);
                    return;
                }
                mainRows.push({ desc: data.desc || '', wt: data.wt || '', rate: data.rate || '', misc: data.misc || '', amt: data.amt || '', id: Date.now() });
                render();
            }

            function addOldRow(data = {}) {
                if (oldRows.length >= MAX_OLD_ROWS) {
                    alert(`Maximum ${MAX_OLD_ROWS} old items allowed to fit on one page.`);
                    return;
                }
                oldRows.push({ desc: data.desc || '', wt: data.wt || '', purity: data.purity || 100, rate: data.rate || '', val: data.val || '', id: Date.now() });
                render();
            }

            function updateMainRow(id, field, value) {
                const row = mainRows.find(r => r.id === id);
                if (!row) return;
                row[field] = value;

                // Logic: 
                // If editing Wt, Rate, or Misc -> Auto Calc Amount
                // If editing Amount -> Manual Override (do nothing to others)

                if (field === 'wt' || field === 'rate' || field === 'misc') {
                    const wt = parseFloat(row.wt) || 0;
                    const rate = parseFloat(row.rate) || 0;
                    const misc = parseFloat(row.misc) || 0;

                    // Only calculate if at least weight is present, OR just misc is present
                    if (wt > 0 || misc > 0) {
                        row.amt = (wt * rate) + misc;
                    }
                }

                saveData();
                renderStats();

                // Force update the input value if it was a calculated update
                if (field !== 'amt') {
                    const amtInput = document.querySelector(`input[oninput="updateMainRow(${row.id}, 'amt', this.value)"]`);
                    if (amtInput) amtInput.value = row.amt;
                }
            }

            function updateOldRow(id, field, value) {
                const row = oldRows.find(r => r.id === id);
                if (!row) return;
                row[field] = value;

                // Logic: Auto-calculate if inputs change, otherwise allow manual override
                if (field === 'wt' || field === 'rate' || field === 'purity') {
                    const wt = parseFloat(row.wt) || 0;
                    const rate = parseFloat(row.rate) || 0;
                    const purity = parseFloat(row.purity) || 0;

                    // Calc if components exist
                    if (wt > 0 || rate > 0) {
                        row.val = wt * rate * (purity / 100);
                    }
                }

                saveData();
                renderStats();

                // Sync input if calculated
                if (field !== 'val') {
                    const valInput = document.querySelector(`input[oninput="updateOldRow(${row.id}, 'val', this.value)"]`);
                    if (valInput) valInput.value = row.val;
                }
            }

            function deleteMainRow(id) {
                if (mainRows.length <= 1) return;
                mainRows = mainRows.filter(r => r.id !== id);
                render();
                saveData();
            }

            function deleteOldRow(id) {
                if (oldRows.length <= 1) {
                    // Just clear first row if it's the only one
                    oldRows[0] = { desc: '', wt: '', purity: 100, rate: '', val: 0, id: oldRows[0].id };
                    render(); saveData(); return;
                }
                oldRows = oldRows.filter(r => r.id !== id);
                render();
                saveData();
            }

            // --- Rendering ---
            function render() {
                const mainBody = document.getElementById('mainBody');
                mainBody.innerHTML = '';
                mainRows.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                <td class="no-print" style="color:#aaa; font-size:0.8rem;">${index + 1}</td>
                <td><input type="text" class="text-left" value="${row.desc}" placeholder="Item Description" oninput="updateMainRow(${row.id}, 'desc', this.value)"></td>
                <td><input type="number" value="${row.wt}" placeholder="-" oninput="updateMainRow(${row.id}, 'wt', this.value)"></td>
                <td><input type="number" value="${row.rate}" placeholder="-" oninput="updateMainRow(${row.id}, 'rate', this.value)"></td>
                <td><input type="number" value="${row.misc}" placeholder="0" oninput="updateMainRow(${row.id}, 'misc', this.value)"></td>
                <td><input type="number" value="${row.amt}" placeholder="0" oninput="updateMainRow(${row.id}, 'amt', this.value)" style="font-weight:600;"></td>
                <td class="no-print"><i class="fas fa-times remove-icon" onclick="deleteMainRow(${row.id})"></i></td>
            `;
                    mainBody.appendChild(tr);
                });

                const oldBody = document.getElementById('oldBody');
                oldBody.innerHTML = '';
                oldRows.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                <td><input type="text" class="text-left" value="${row.desc}" placeholder="Old Item" oninput="updateOldRow(${row.id}, 'desc', this.value)"></td>
                <td><input type="number" value="${row.wt}" placeholder="-" oninput="updateOldRow(${row.id}, 'wt', this.value)"></td>
                <td><input type="number" value="${row.purity}" placeholder="100" oninput="updateOldRow(${row.id}, 'purity', this.value)"></td>
                <td><input type="number" value="${row.rate}" placeholder="-" oninput="updateOldRow(${row.id}, 'rate', this.value)"></td>
                <td><input type="number" value="${row.val}" placeholder="0" oninput="updateOldRow(${row.id}, 'val', this.value)" style="font-weight:600; color:#c0392b;"></td>
                <td class="no-print"><i class="fas fa-times remove-icon" onclick="deleteOldRow(${row.id})"></i></td>
            `;
                    oldBody.appendChild(tr);
                });

                renderStats();



                // Conditional visibility for Old Gold section
                // Check if any old row has meaningful content
                const hasOldItems = oldRows.some(r => {
                    const desc = (r.desc || '').trim();
                    const wt = parseFloat(r.wt) || 0;
                    const val = parseFloat(r.val) || 0;
                    return desc.length > 0 || wt > 0 || val > 0;
                });

                const oldGoldSection = document.getElementById('oldGoldSection');
                const oldDeductionRow = document.getElementById('oldDeductionRow');
                if (oldGoldSection) {
                    // If no items, add 'hide-in-print' class. 
                    // We also might want to visually dim it or indicate it's empty in edit mode, 
                    // but for now, just controlling print visibility is key.
                    if (!hasOldItems) {
                        oldGoldSection.classList.add('hide-in-print');
                    } else {
                        oldGoldSection.classList.remove('hide-in-print');
                    }
                }
                if (oldDeductionRow) {
                    if (!hasOldItems) {
                        oldDeductionRow.classList.add('hide-in-print');
                    } else {
                        oldDeductionRow.classList.remove('hide-in-print');
                    }
                }
            }

            function renderStats() {
                const subtotal = mainRows.reduce((sum, r) => sum + (parseFloat(r.amt) || 0), 0);
                const oldTotal = oldRows.reduce((sum, r) => sum + (parseFloat(r.val) || 0), 0);
                const grandTotal = subtotal - oldTotal;

                document.getElementById('txtSubtotal').innerText = '‚Çπ ' + formatCurrency(subtotal);
                document.getElementById('txtOldTotal').innerText = '‚Çπ ' + formatCurrency(oldTotal);
                document.getElementById('txtGrandTotal').innerText = '‚Çπ ' + formatCurrency(grandTotal);
            }

            // --- Persistence ---
            function saveData() {
                const data = {
                    custName: document.getElementById('custName').value,
                    estNo: document.getElementById('estNo').value,
                    mainRows,
                    oldRows
                };
                localStorage.setItem('pj_invoice_v1', JSON.stringify(data));
            }

            function loadData() {
                const saved = localStorage.getItem('pj_invoice_v1');
                if (saved) {
                    const data = JSON.parse(saved);
                    document.getElementById('custName').value = data.custName || '';
                    if (data.estNo) document.getElementById('estNo').value = data.estNo;

                    if (data.mainRows && data.mainRows.length) mainRows = data.mainRows;
                    if (data.oldRows && data.oldRows.length) oldRows = data.oldRows;
                }
            }

            function resetForm() {
                if (confirm('Create New Invoice? This will generate a new Estimate No.')) {
                    // generate new unique number
                    const newNo = getNextEstimateNumber();

                    // Reset State
                    mainRows = [];
                    oldRows = [];
                    document.getElementById('custName').value = '';
                    document.getElementById('estNo').value = newNo;

                    addMainRow();
                    addOldRow();
                    saveData(); // Save new state immediately
                    render();
                }
            }
        </script>
</body>

</html>